#!/bin/bash
# One-time setup: configure Dropbox and/or Overleaf sync for this project
#
# Usage (interactive):
#   bash templates/setup-sync.sh
#
# Usage (non-interactive, for Claude Code):
#   bash templates/setup-sync.sh \
#     --dropbox "C:/Users/me/Dropbox/shared-project" \
#     --overleaf "C:/Users/me/Dropbox/Apps/Overleaf/my-paper" \
#     --push "project/output/tables:tables,project/output/figures:figures" \
#     --pull ".:project/paper"
#
# All flags are optional. Omit --dropbox if no main Dropbox sync.
# Omit --overleaf/--push/--pull if no Overleaf sync.
#
# Uses robocopy (built into Windows) for file sync.

set -e

REPO_PATH="$(pwd)"

if [[ ! -f "$REPO_PATH/CLAUDE.md" ]]; then
    echo "Error: run this from the repo root (where CLAUDE.md lives)."
    exit 1
fi

# --- Parse command-line arguments ---
DROPBOX_PATH=""
OVERLEAF_PATH=""
OVERLEAF_PUSH=""
OVERLEAF_PULL=""
NON_INTERACTIVE=false

while [[ $# -gt 0 ]]; do
    case "$1" in
        --dropbox)    DROPBOX_PATH="$2";  NON_INTERACTIVE=true; shift 2 ;;
        --overleaf)   OVERLEAF_PATH="$2"; NON_INTERACTIVE=true; shift 2 ;;
        --push)       OVERLEAF_PUSH="$2"; shift 2 ;;
        --pull)       OVERLEAF_PULL="$2"; shift 2 ;;
        *)            echo "Unknown option: $1"; exit 1 ;;
    esac
done

# --- Interactive mode if no arguments ---
if [[ "$NON_INTERACTIVE" == "false" ]]; then
    echo "=== Sync setup ==="
    echo ""

    # Main Dropbox
    read -rp "Do you sync project/ with a main Dropbox folder? (y/n): " USE_DROPBOX
    if [[ "$USE_DROPBOX" == "y" || "$USE_DROPBOX" == "Y" ]]; then
        read -rp "Dropbox path (e.g., C:/Users/you/Dropbox/shared-project): " DROPBOX_PATH
        if [[ -z "$DROPBOX_PATH" ]]; then
            echo "Error: Dropbox path is required."
            exit 1
        fi
    fi

    # Overleaf Dropbox
    read -rp "Do you sync with an Overleaf Dropbox folder? (y/n): " USE_OVERLEAF
    if [[ "$USE_OVERLEAF" == "y" || "$USE_OVERLEAF" == "Y" ]]; then
        read -rp "Overleaf Dropbox path (e.g., C:/Users/you/Dropbox/Apps/Overleaf/my-paper): " OVERLEAF_PATH
        if [[ -z "$OVERLEAF_PATH" ]]; then
            echo "Error: Overleaf path is required."
            exit 1
        fi

        echo ""
        echo "PUSH mappings: directories pushed TO Overleaf on every commit."
        echo "  Format: local-path:overleaf-path (both relative to their roots)"
        echo "  Example: project/output/tables:tables"
        echo "  Enter one per line, empty line to finish:"

        OVERLEAF_PUSH=""
        while true; do
            read -rp "  push> " mapping
            if [[ -z "$mapping" ]]; then break; fi
            if [[ "$mapping" != *":"* ]]; then
                echo "  Invalid format. Use local:overleaf (e.g., project/output/tables:tables)"
                continue
            fi
            if [[ -n "$OVERLEAF_PUSH" ]]; then
                OVERLEAF_PUSH="$OVERLEAF_PUSH,$mapping"
            else
                OVERLEAF_PUSH="$mapping"
            fi
        done

        echo ""
        echo "PULL mappings: directories pulled FROM Overleaf at session start."
        echo "  Format: overleaf-path:local-path (both relative to their roots)"
        echo "  Example: .:project/paper  (pulls entire Overleaf folder into project/paper/)"
        echo "  Enter one per line, empty line to finish:"

        OVERLEAF_PULL=""
        while true; do
            read -rp "  pull> " mapping
            if [[ -z "$mapping" ]]; then break; fi
            if [[ "$mapping" != *":"* ]]; then
                echo "  Invalid format. Use overleaf:local (e.g., .:project/paper)"
                continue
            fi
            if [[ -n "$OVERLEAF_PULL" ]]; then
                OVERLEAF_PULL="$OVERLEAF_PULL,$mapping"
            else
                OVERLEAF_PULL="$mapping"
            fi
        done
    fi
fi

if [[ -z "$DROPBOX_PATH" && -z "$OVERLEAF_PATH" ]]; then
    echo "No sync targets configured. Nothing to do."
    exit 0
fi

# --- Write .sync-config ---
echo ""
echo "Writing .sync-config..."
cat > "$REPO_PATH/.sync-config" <<CONF
# Sync configuration (generated by templates/setup-sync.sh)
# This file is gitignored---it contains machine-specific paths.

REPO_PATH="$REPO_PATH"
DROPBOX_PATH="$DROPBOX_PATH"
OVERLEAF_PATH="$OVERLEAF_PATH"
OVERLEAF_PUSH="$OVERLEAF_PUSH"
OVERLEAF_PULL="$OVERLEAF_PULL"
CONF
echo "  Created .sync-config"

# --- Install post-commit hook ---
echo "Installing post-commit hook..."
HOOK_FILE="$REPO_PATH/.git/hooks/post-commit"

if [[ -f "$HOOK_FILE" ]]; then
    echo "  Warning: $HOOK_FILE already exists. Backing up to post-commit.bak"
    cp "$HOOK_FILE" "$HOOK_FILE.bak"
fi

cat > "$HOOK_FILE" <<'HOOK'
#!/bin/bash
# Post-commit hook: safe push of project/ to Dropbox and/or Overleaf
# Generated by templates/setup-sync.sh
# Safe sync: never deletes remote-only files, never overwrites newer remote files

REPO_ROOT="$(git rev-parse --show-toplevel)"
CONFIG="$REPO_ROOT/.sync-config"

if [[ ! -f "$CONFIG" ]]; then
    echo "post-commit: no .sync-config found. Run bash templates/setup-sync.sh"
    exit 0
fi

source "$CONFIG"

# Convert Git Bash path to Windows path for robocopy
to_win() { local p="$1"; p="${p/#\/c\//C:/}"; p="${p/#\/d\//D:/}"; echo "${p//\//\\}"; }

# robocopy exit codes 0-7 are success, 8+ are errors
run_robocopy() {
    MSYS_NO_PATHCONV=1 robocopy.exe "$@"
    local rc=$?
    if [[ $rc -ge 8 ]]; then
        echo "  robocopy failed (exit code $rc)"
        return 1
    fi
    return 0
}

# Only exclude universal artifacts — infrastructure directories are already
# out of scope because this sync operates on project/ <-> Dropbox.
EXCLUDE_DIRS=("__pycache__" ".git")
EXCLUDE_FILES=(".env" "Thumbs.db" ".DS_Store")
EXCLUDE_EXTS=("*.pyc" "*.aux" "*.log" "*.bbl" "*.blg" "*.synctex.gz" "*.nav" "*.out" "*.snm" "*.toc" "*.vrb")

XD_FLAGS=()
for d in "${EXCLUDE_DIRS[@]}"; do XD_FLAGS+=("$d"); done
XF_FLAGS=()
for f in "${EXCLUDE_FILES[@]}"; do XF_FLAGS+=("$f"); done
for e in "${EXCLUDE_EXTS[@]}"; do XF_FLAGS+=("$e"); done

# Phase 1: Detect files that are newer on the remote than locally.
# Runs robocopy REMOTE -> LOCAL in list-only mode (/L) with /XO to find
# only files where the remote version is newer. Informational only.
detect_newer() {
    local remote_dir="$1" local_dir="$2" label="$3"
    local SRC DST output files
    SRC=$(to_win "$remote_dir")
    DST=$(to_win "$local_dir")

    output=$(MSYS_NO_PATHCONV=1 robocopy.exe "$SRC" "$DST" \
        /E /XO /L /NDL /NJH /NJS /NP /NC /NS \
        /XD "${XD_FLAGS[@]}" /XF "${XF_FLAGS[@]}" 2>/dev/null) || true

    files=$(echo "$output" | sed 's/^[[:space:]]*//' | sed '/^$/d')

    if [[ -n "$files" ]]; then
        echo ""
        echo "  WARNING: These $label files are NEWER than your local copies:"
        while IFS= read -r f; do
            echo "    $f"
        done <<< "$files"
        echo "  Run 'bash sync-pull.sh' to pull these changes."
        echo ""
    fi
}

# --- Main Dropbox: detect newer then safe push ---
if [[ -n "$DROPBOX_PATH" ]]; then
    echo "Pushing project/ to Dropbox..."
    detect_newer "$DROPBOX_PATH" "$REPO_PATH/project" "Dropbox"
    SRC=$(to_win "$REPO_PATH/project")
    DST=$(to_win "$DROPBOX_PATH")
    # Phase 2: Safe push — /E /XO (no /MIR, no /PURGE)
    # /E  = copy subdirectories (never deletes destination extras)
    # /XO = skip files where local is older than destination
    run_robocopy "$SRC" "$DST" /E /XO /XJ /NJH /NJS /NDL /NP \
        /XD "${XD_FLAGS[@]}" /XF "${XF_FLAGS[@]}"
    echo "Dropbox push complete."
fi

# --- Overleaf: detect newer then safe push ---
if [[ -n "$OVERLEAF_PATH" && -n "$OVERLEAF_PUSH" ]]; then
    echo "Pushing outputs to Overleaf..."
    IFS=',' read -ra PAIRS <<< "$OVERLEAF_PUSH"
    for pair in "${PAIRS[@]}"; do
        src="${pair%%:*}"
        dest="${pair##*:}"
        if [[ -d "$REPO_PATH/$src" ]]; then
            detect_newer "$OVERLEAF_PATH/$dest" "$REPO_PATH/$src" "Overleaf"
            SRC=$(to_win "$REPO_PATH/$src")
            DST=$(to_win "$OVERLEAF_PATH/$dest")
            run_robocopy "$SRC" "$DST" /E /XO /XJ /NJH /NJS /NDL /NP
            echo "  $src -> $dest"
        fi
    done
    echo "Overleaf push complete."
fi
HOOK
chmod +x "$HOOK_FILE"
echo "  Created $HOOK_FILE"

# --- Create sync-pull.sh ---
echo "Creating sync-pull.sh..."
cat > "$REPO_PATH/sync-pull.sh" <<'PULL'
#!/bin/bash
# Pull external changes into the repo using robocopy
# Run manually at the start of each session
# Safe sync: /E /XO (no deletion, only newer files)

CONFIG="$(dirname "$0")/.sync-config"

if [[ ! -f "$CONFIG" ]]; then
    echo "No .sync-config found. Run bash templates/setup-sync.sh"
    exit 1
fi

source "$CONFIG"

# Convert Git Bash path to Windows path for robocopy
to_win() { local p="$1"; p="${p/#\/c\//C:/}"; p="${p/#\/d\//D:/}"; echo "${p//\//\\}"; }

# robocopy exit codes 0-7 are success, 8+ are errors
run_robocopy() {
    MSYS_NO_PATHCONV=1 robocopy.exe "$@"
    local rc=$?
    if [[ $rc -ge 8 ]]; then
        echo "  robocopy failed (exit code $rc)"
        return 1
    fi
    return 0
}

# Only exclude universal artifacts — infrastructure directories are already
# out of scope because this sync operates on project/ <-> Dropbox.
EXCLUDE_DIRS=("__pycache__" ".git")
EXCLUDE_FILES=(".env" "Thumbs.db" ".DS_Store")
EXCLUDE_EXTS=("*.pyc" "*.aux" "*.log" "*.bbl" "*.blg" "*.synctex.gz" "*.nav" "*.out" "*.snm" "*.toc" "*.vrb")

XD_FLAGS=()
for d in "${EXCLUDE_DIRS[@]}"; do XD_FLAGS+=("$d"); done
XF_FLAGS=()
for f in "${EXCLUDE_FILES[@]}"; do XF_FLAGS+=("$f"); done
for e in "${EXCLUDE_EXTS[@]}"; do XF_FLAGS+=("$e"); done

# Preview: dry-run showing which files will be pulled
preview_pull() {
    local src_dir="$1" dest_dir="$2" label="$3"
    local SRC DST output files count
    SRC=$(to_win "$src_dir")
    DST=$(to_win "$dest_dir")

    output=$(MSYS_NO_PATHCONV=1 robocopy.exe "$SRC" "$DST" \
        /E /XO /L /NDL /NJH /NJS /NP /NC /NS \
        /XD "${XD_FLAGS[@]}" /XF "${XF_FLAGS[@]}" 2>/dev/null) || true

    files=$(echo "$output" | sed 's/^[[:space:]]*//' | sed '/^$/d')

    if [[ -n "$files" ]]; then
        count=$(echo "$files" | wc -l | tr -d ' ')
        echo "  $count file(s) to pull from $label:"
        while IFS= read -r f; do
            echo "    $f"
        done <<< "$files"
    else
        echo "  No updates from $label (local is up to date)."
    fi
}

# --- Main Dropbox: pull into project/ ---
if [[ -n "$DROPBOX_PATH" ]]; then
    echo "Pulling from Dropbox into project/..."
    preview_pull "$DROPBOX_PATH" "$REPO_PATH/project" "Dropbox"
    mkdir -p "$REPO_PATH/project"
    SRC=$(to_win "$DROPBOX_PATH")
    DST=$(to_win "$REPO_PATH/project")
    run_robocopy "$SRC" "$DST" /E /XO /XJ /NJH /NJS /NDL /NP \
        /XD "${XD_FLAGS[@]}" /XF "${XF_FLAGS[@]}"
    echo "Dropbox pull complete."
fi

# --- Overleaf: pull configured directories ---
if [[ -n "$OVERLEAF_PATH" && -n "$OVERLEAF_PULL" ]]; then
    echo "Pulling from Overleaf..."
    IFS=',' read -ra PAIRS <<< "$OVERLEAF_PULL"
    for pair in "${PAIRS[@]}"; do
        src="${pair%%:*}"
        dest="${pair##*:}"
        if [[ "$src" == "." ]]; then
            SRC_PATH="$OVERLEAF_PATH"
        else
            SRC_PATH="$OVERLEAF_PATH/$src"
        fi
        preview_pull "$SRC_PATH" "$REPO_PATH/$dest" "Overleaf ($src)"
        mkdir -p "$REPO_PATH/$dest"
        SRC=$(to_win "$SRC_PATH")
        DST=$(to_win "$REPO_PATH/$dest")
        run_robocopy "$SRC" "$DST" /E /XJ /NJH /NJS /NDL /NP
        echo "  $src -> $dest"
    done
    echo "Overleaf pull complete."
fi

echo ""
echo "Checking git status..."
cd "$REPO_PATH" && git status --short
PULL
chmod +x "$REPO_PATH/sync-pull.sh"
echo "  Created sync-pull.sh"

echo ""
echo "=== Setup complete ==="
echo ""
if [[ -n "$DROPBOX_PATH" ]]; then
    echo "Main Dropbox:  $DROPBOX_PATH"
    echo "  push: every commit safely syncs project/ to Dropbox (no deletion)"
    echo "  pull: run 'bash sync-pull.sh' to pull collaborator changes"
fi
if [[ -n "$OVERLEAF_PATH" ]]; then
    echo "Overleaf:      $OVERLEAF_PATH"
    if [[ -n "$OVERLEAF_PUSH" ]]; then
        echo "  push (on commit):"
        IFS=',' read -ra PAIRS <<< "$OVERLEAF_PUSH"
        for pair in "${PAIRS[@]}"; do
            echo "    ${pair%%:*} -> ${pair##*:}"
        done
    fi
    if [[ -n "$OVERLEAF_PULL" ]]; then
        echo "  pull (manual):"
        IFS=',' read -ra PAIRS <<< "$OVERLEAF_PULL"
        for pair in "${PAIRS[@]}"; do
            echo "    ${pair%%:*} -> ${pair##*:}"
        done
    fi
fi
echo ""
echo "Config saved to .sync-config (gitignored)."
echo "Run 'bash sync-pull.sh' to do the initial pull."
